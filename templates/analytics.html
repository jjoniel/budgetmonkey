<!DOCTYPE html>
<html>
<head>
    <title>analytics</title>

    <!-- libs -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- fonts & shared palette -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,100;9..40,400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@500&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/static/navbar.css">
    <link rel="stylesheet" href="/static/transaction.css">

    <style>
        .wrap{max-width:1200px;margin:4% auto 5%;padding:0 2%;text-align:center}
        .big-number{font-size:3em;font-family:'DM Sans',sans-serif;font-weight:200;margin:0}
        .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:40px;margin-top:60px}
        canvas{background:#fff;border-radius:8px;padding:15px;height: 300px;}
        .no-data{margin:20% auto;text-align:center;font-size:1.3em}
        .grid canvas{
            height:340px;
            max-height:340px;
        }
    </style>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="theme-color" content="#EAE151">
</head>
<body>
<div class="page-header"><span id="logo"><a href="../">budgetmonkey</a></span></div>

<!-- SHARED NAVBAR -->
<div class="navbar">
    <a href="/add_transaction">Add Transaction</a>
    <a href="/receipts">View Receipts</a>
    <a href="/analytics" class="active">Analytics</a>
</div>

{% if no_data %}
    <div class="no-data">
        <p>Nothing to analyse yet — add a few transactions first!</p>
    </div>
{% else %}
    <div class="wrap">
        <h1>Spending <span class="popout">Insights</span></h1>
        <p>Total spent so far</p>
        <p class="big-number">${{ "%.2f"|format(total_spending) }}</p>

        <div class="grid">
            <!-- Category pie -->
            <div>
                <h3>By Category</h3>
                <canvas id="catChart"></canvas>
            </div>

            <div>
                <h3>Monthly Spend ($)</h3>
                <canvas id="monthChart"></canvas>
            </div>

            <div>
                <h3>Transactions / Month</h3>
                <canvas id="txnChart"></canvas>
            </div>

            <div style="grid-column:1 / -1;">
                <h3>Top Vendors</h3>
                <canvas id="vendorChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        const palette = {
            accent : '#FCA311',
            cream  : '#F9EA9A',
            dark   : '#28221f'
        };

        const brandCycle = (i)=>[palette.accent,palette.cream,palette.dark,'#EAE151','#684E32'][i%5];

        /* ---------- pie: category ---------- */
        const catLabels = {{ category_spending.keys() | list | tojson }};
        const catValues = {{ category_spending.values() | list | tojson }};
        new Chart('catChart',{
            type:'pie',
            data:{
                labels:catLabels,
                datasets:[{
                    data:catValues,
                    backgroundColor:catLabels.map((_,i)=>brandCycle(i)),
                    borderColor:palette.dark,
                    borderWidth:1
                }]
            },
            options:{plugins:{legend:{position:'bottom'}},maintainAspectRatio:false}
        });

        /* ---------- line: monthly ---------- */
        new Chart('monthChart',{
            type:'line',
            data:{
                labels:{{ sorted_months | tojson }},
                datasets:[{
                    data:{{ monthly_spending_list | tojson }},
                    label:'$ spent',
                    fill:true,
                    tension:0.35,
                    borderColor:palette.accent,
                    backgroundColor:'rgba(252,163,17,0.25)',
                    pointBackgroundColor:palette.accent,
                    pointBorderColor:palette.dark
                }]
            },
            options:{
                maintainAspectRatio:false,
                plugins:{legend:{display:false}},
                scales:{y:{beginAtZero:true,color:palette.dark},x:{color:palette.dark}}
            }
        });

        /* ---------- bar: vendors ---------- */
        new Chart('vendorChart',{
            type:'bar',
            data:{
                labels:{{ top_vendors | map(attribute=0)|list|tojson }},
                datasets:[{
                    data:{{ top_vendors | map(attribute=1)|list|tojson }},
                    backgroundColor:palette.accent,
                    borderColor:palette.dark,
                    borderWidth:1
                }]
            },
            options:{
                maintainAspectRatio:false,
                indexAxis:'y',
                plugins:{legend:{display:false}},
                scales:{x:{beginAtZero:true},y:{ticks:{crossAlign:'start'}}}
            }
        });

        new Chart('txnChart',{
            type:'bar',
            data:{
                labels:{{ sorted_months | tojson }},
                datasets:[{
                    data:{{ monthly_counts_list | tojson }},
                    backgroundColor:palette.cream,
                    borderColor:palette.dark,
                    borderWidth:1
                }]
            },
            options:{
                maintainAspectRatio:false,
                plugins:{legend:{display:false}},
                scales:{
                    y:{beginAtZero:true,title:{display:true,text:'# transactions'},ticks:{color:palette.dark}},
                    x:{ticks:{autoSkip:false}}
                }
            }
        });
    </script>

{% endif %}
</body>
</html>
